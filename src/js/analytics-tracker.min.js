class AnalyticsTracker{constructor(e={}){this.config={batchSize:e.batchSize||10,flushInterval:e.flushInterval||5e3,maxRetries:e.maxRetries||3,endpoint:e.endpoint||"/api/analytics",debug:e.debug||!1,...e},this.eventQueue=[],this.isOnline=navigator.onLine,this.sessionId=this.generateSessionId(),this.deviceInfo=this.getDeviceInfo(),this.features={beacon:"sendBeacon"in navigator,idle:"requestIdleCallback"in window,observer:"IntersectionObserver"in window,performance:"performance"in window&&"getEntriesByType"in performance},this.init()}init(){this.setupEventListeners(),this.startBatchProcessor(),this.trackPageLoad(),this.config.debug&&this.features}track(e,t={}){const n={event:e,data:t,timestamp:Date.now(),sessionId:this.sessionId,url:window.location.href,referrer:document.referrer,viewport:{width:window.innerWidth,height:window.innerHeight},device:this.deviceInfo,userAgent:navigator.userAgent};this.addToQueue(n),this.config.debug}trackPageView(e=window.location.pathname){this.track("page_view",{page:e,title:document.title,loadTime:this.getPageLoadTime()})}trackInteraction(e,t,n={}){this.track("user_interaction",{element:e.tagName.toLowerCase(),action:t,elementId:e.id,elementClass:e.className,...n})}trackPerformance(){if(!this.features.performance)return;const e=performance.getEntriesByType("navigation")[0],t=performance.getEntriesByType("paint"),n={loadTime:e?.loadEventEnd-e?.loadEventStart,domContentLoaded:e?.domContentLoadedEventEnd-e?.domContentLoadedEventStart,firstPaint:t.find(e=>"first-paint"===e.name)?.startTime,firstContentfulPaint:t.find(e=>"first-contentful-paint"===e.name)?.startTime,transferSize:e?.transferSize,connectionType:navigator.connection?.effectiveType};this.track("performance_metrics",n)}trackScrollDepth(){let e=0;const t=[25,50,75,100],n=new Set,trackScroll=()=>{const i=Math.round(window.scrollY/(document.documentElement.scrollHeight-window.innerHeight)*100);e=Math.max(e,i),t.forEach(e=>{i>=e&&!n.has(e)&&(n.add(e),this.track("scroll_depth",{depth:e}))})};let i=!1;window.addEventListener("scroll",()=>{i||(this.features.idle?requestIdleCallback(trackScroll):requestAnimationFrame(trackScroll),i=!0,setTimeout(()=>{i=!1},100))},{passive:!0}),window.addEventListener("beforeunload",()=>{this.track("session_end",{maxScrollDepth:e})})}trackElementVisibility(e,t){if(!this.features.observer)return;const n=new IntersectionObserver(e=>{e.forEach(e=>{if(e.isIntersecting){const n={element:e.target.tagName.toLowerCase(),elementId:e.target.id,visibilityRatio:e.intersectionRatio};this.track("element_visible",n),t&&t(e.target,n)}})},{threshold:[.1,.5,.9]});return e.forEach(e=>n.observe(e)),n}addToQueue(e){this.eventQueue.push(e),this.eventQueue.length>=this.config.batchSize&&this.flush()}async flush(){if(0===this.eventQueue.length)return;const e=this.eventQueue.splice(0,this.config.batchSize);try{await this.sendBatch(e),this.config.debug&&e.length}catch(t){console.error("ðŸ“Š Failed to send analytics batch:",t),this.eventQueue.unshift(...e)}}async sendBatch(e){const t=JSON.stringify(e);if(this.features.beacon&&"hidden"===document.visibilityState){if(!navigator.sendBeacon(this.config.endpoint,t))throw new Error("Beacon send failed");return}const n=await fetch(this.config.endpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:t,keepalive:!0});if(!n.ok)throw new Error(`HTTP ${n.status}: ${n.statusText}`);return n}setupEventListeners(){window.addEventListener("online",()=>{this.isOnline=!0,this.track("connection_restored"),this.flush()}),window.addEventListener("offline",()=>{this.isOnline=!1,this.track("connection_lost")}),document.addEventListener("visibilitychange",()=>{"hidden"===document.visibilityState?(this.track("page_hidden"),this.flush()):this.track("page_visible")}),window.addEventListener("beforeunload",()=>{this.flush()}),this.trackScrollDepth()}startBatchProcessor(){setInterval(()=>{this.eventQueue.length>0&&this.flush()},this.config.flushInterval)}trackPageLoad(){"complete"===document.readyState?(this.trackPageView(),this.trackPerformance()):window.addEventListener("load",()=>{this.trackPageView(),this.trackPerformance()})}getDeviceInfo(){return{screen:{width:screen.width,height:screen.height,colorDepth:screen.colorDepth},timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,language:navigator.language,platform:navigator.platform,cookieEnabled:navigator.cookieEnabled,connectionType:navigator.connection?.effectiveType||"unknown"}}getPageLoadTime(){if(!this.features.performance)return null;const e=performance.getEntriesByType("navigation")[0];return e?e.loadEventEnd-e.loadEventStart:null}generateSessionId(){const e=sessionStorage.getItem("analytics_session_id");if(e)return e;const t=`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;return sessionStorage.setItem("analytics_session_id",t),t}enableDebug(){this.config.debug=!0}disableDebug(){this.config.debug=!1}getStatus(){return{queueLength:this.eventQueue.length,sessionId:this.sessionId,isOnline:this.isOnline,features:this.features,config:this.config}}}"undefined"!=typeof window&&(window.AnalyticsTracker=AnalyticsTracker),"undefined"!=typeof module&&module.exports&&(module.exports=AnalyticsTracker);